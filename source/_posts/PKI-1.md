---
title: PKI 1
date: 2023-01-07 22:55:52
tags:
    - Security
    - Architecture
---

### 简介
PKI（Public Key Infrastructure）防止中间人攻击，建立可信通信通道；核心问题是解决公钥真实性问题。


### PKI系统
一个简单的PKI系统包括证书机构CA、注册机构RA和相应的PKI存储库。CA用于签发并管理证书；RA可作为CA的一部分，也可以独立，其功能包括个人身份审核、CRL管理、密钥产生和密钥对备份等；PKI存储库包括LDAP目录服务器和普通数据库，用于对用户申请、证书、密钥、CRL和日志等信息进行存储和管理，并提供一定的查询功能。
{% asset_img pki_arch.jpeg link list %}

- 证书颁发机构（Certificate Authority，CA）：CA是PKI的信任基础，它管理公钥的整个生命周期，其作用包括：发放证书、规定证书的有效期，以及通过发布证书废除列表（CRL）废除证书。

- 注册机构（Registration Authority，RA）：RA提供用户和CA之间的一个接口，它获取并认证用户的身份，向CA提出证书请求。它主要完成收集用户信息和确认用户身份的功能。这里指的用户，是指将要向认证中心（即CA）申请数字证书的客户，可以是个人，也可以是集团或团体、某政府机构等。注册管理一般由一个独立的注册机构（即RA）来承担。它接受用户的注册申请，审查用户的申请资格，并决定是否同意CA给其签发数字证书。注册机构并不给用户签发证书，而只是对用户进行资格审查。因此，RA可以设置在直接面对客户的业务部门，如银行的营业部、机构认识部门等。当然，对于一个规模较小的PKI应用系统来说，可把注册管理的职能由认证中心CA来完成，而不设立独立运行的RA。但这并不是取消了PKI的注册功能，而只是将其作为CA的一项功能而已。PKI国际标准推荐由一个独立的RA来完成注册管理的任务，可以增强应用系统的安全。

- 数字证书存储库（Certificate Repository）：用于存储和分发数字证书的数据库或者目录服务。用户可以从数字证书存储库中获取其他用户的证书，以进行身份验证和建立安全通信。

- 密钥管理系统（Key Management System）：用于生成、存储和管理公钥和私钥的系统。密钥管理系统负责保护私钥的安全性，防止私钥被未授权的人获取。

- 证书撤销列表（Certificate Revocation List，CRL）：用于存储已经失效的证书列表，包含了被吊销的证书的信息。在进行数字证书验证时，可以使用CRL来检查证书是否被吊销。

- LDAP服务器：LDAP服务器提供目录浏览服务，负责将注册机构服务器传输过来的用户信息以及数字证书加入到服务器上。这样其他用户通过访问LDAP服务器就能够得到其他用户的数字证书。

### 证书申请过程
- 用户申请：用户获取CA的数字证书（根证书），与安全服务器建立连接；生成自己的公钥和私钥，将公钥和自己的身份信息提交给RA服务器。

- RA审核：RA收到用户的申请，用户向RA证明自己的身份，RA进行核对。如果RA同意用户申请证书的请求，则对证书申请信息做数字签名；否则拒绝用户的申请。

- CA发行证书：RA将用户申请和RA签名传输给CA，CA对RA数字签名做认证，如果验证通过，则同意用户请求，颁发证书，然后将证书输出。如果验证不通过，则拒绝证书申请。

- RA转发证书：RA从CA得到新的证书，首先将证书输出到LDAP服务器以提供目录浏览，再通知用户证书发行成功，告知证书序列号，到指定的网址去下载证书。

- 用户证书获取：用户使用证书序列号去指定网址下载自己的数字证书，只有持有与申请时提交的公钥配对的私钥才能下载成功。

### 证书撤销过程
认证中心CA负责维护和发布证书废除列表CRL（certificate revocation lists，又称为证书黑名单）。当一个证书，特别是其中的公钥因为其他原因无效时（不是因为到期），CRL提供了一种通知用户和其他应用的中心管理方式。CA系统生成CRL以后，放到LDAP服务器中或Web服务器的合适位置，供用户查询或下载。步骤如下：

- 用户申请：用户向RA发送一封签名加密邮件，申请撤销证书。
- RA审核：注册机构同意证书撤销，并对申请签名。
- CA更新CRL：CA验证证书撤销请求的RA签名，如果正确，则同意申请，并更新CRL，并输出。
- RA转发CRL：注册中心收到CRL，以多种方式将CRL公布（包括LDAP服务器）。
- 用户告知：用户访问LDAP服务器，下载或浏览CRL。

### X.509证书协议
X.509证书包含有关颁发者CA和证书使用者的信息，用于解决“公钥属于谁”的问题。X.509证书标准字段包括以下内容：
{% asset_img x509_info.png link list %}

许多Internet协议都依赖于X.509，另外还有许多应用程序都在使用PKI技术，包括Web服务器安全、数字签名、文档签名以及数字身份。

- 数字签名和文档签名
数字签名和文档签名是一种特殊类型的电子签名，它能够利用PKI来验证签名者的身份，还能验证签名文档的完整性。数字签名不能以任何方式更改或复制，因为签名是通过生成散列来创建的，该散列通过发件人的私钥进行加密。这种加密验证将签名绑定到原始信息上，可以确保发送者经过身份验证，还能保证信息本身未被篡改。

- 代码签名
代码签名通过对应用程序、驱动程序或软件程序进行数字签名，帮助应用开发商为这些程序提供进一步的保护。通过代码签名，终端用户可以相信代码没有受到第三方的篡改和破坏。为了保障代码的安全性和可信度，代码签名证书提供了软件开发商的签名、公司名称和时间戳。

- 电子邮件证书
电子邮件证书又叫做S/MIME邮件安全证书，可以验证电子邮件发件人身份并加密邮件内容，防止网络钓鱼攻击。通过加密和解密邮件及附件，验证邮件发送方的身份，S/MIME邮件安全证书可以保证邮件的真实性和完整性。

- SSH密钥
SSH又叫做安全外壳协议，而SSH密钥是X.509证书的一种形式，它提供在安全外壳协议中使用的安全访问凭证。由于SSH协议广泛用于云服务、网络环境、文件传输工具和配置管理工具中的远程通信，因此大多数组织使用SSH密钥来验证身份并保护它们免遭误用和恶意攻击。SSH密钥可以提高安全性，实现连接过程、单点登录机制(SSO)、身份和访问管理的自动化。

- 数字身份
X.509数字证书还提供有效的数字身份认证。随着数据和应用程序从传统网络扩展到移动设备、公有云、私有云和物联网设备，身份认证变得越来越重要。数字证书不仅限于对设备进行身份验证，还可用于对人员、数据或应用程序进行身份验证。如今，由于网络攻击者越来越擅长于窃取密码，基于PKI的数字证书使用无密码身份认证来提高安全性，防止密码凭证丢失或被盗取。


### 传输安全示例
{% asset_img pki_use_case.png link list %}
- 服务端S把CA证书发送给客户端。
- 客户端会内置信任CA的证书信息（包含公钥），如果CA不被信任，则找不到对应CA的证书，证书会被判定为非法。
- 客户端利用对应CA的公钥解密签名数据，拿到了摘要1。
- 客户端C读取证书中的相关的明文信息，采用哈希算法加密得到信息摘要2。
- 对比证书的信息摘要1和2，如果一致，则可以确认证书的合法性，即公钥合法。
- 提取出公钥pub_server，至此就认可了服务端S，拿到了服务端的公钥。









