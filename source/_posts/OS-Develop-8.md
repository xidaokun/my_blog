---
title: OS Develop 8
date: 2022-09-07 10:46:23
tags:
   - IT-Basics
   - OS
---

### 简介
本章讨论线程。


### 线程的本质
OS把资源(静态)和执行(动态)分开；线程是指令执行流，它也是调度器的调度单元。

### 相关概念
- 内核线程(KLT)
	Kernel-Level Thread，建立在内核空间内，由内核线程调度器管理。
- 用户线程(UT)
	User Thead，建立在用户空间内，可以在用户空间实现调度，也可以使用内核空间的调度器，内核不能感知到用户线程的存在。它的优势常以线程库的形式提供给开发者，比如Java就曾使用该方式。
- 轻量级进程(LWP)
	是OS提供给用户操作内核线程的接口实现；用户空间可以通过LWP来使用内核线程。

### 线程模型
1，用户线程模型
线程的创建、切换和调度都需要用户程序自己来处理，这种模型局限太大，很少使用。

2，内核线程模型
进程通过轻量级进程(LWP)去使用内核线程，LWP和KLT(内核线程)时一对一的关系。
{% asset_img lwp_klt_single_map.png single model %}

3，混合模型
用户线程和内核线程一起使用的模式；UT通过LWP和KLT建立关系，UT和LWP是N\:M的关系，LWP和KLT是1\:1的关系。
{% asset_img mul_thread_model.png mul model %}

注：Linux采用的是内核线程模型。

### PCB
用来描述进程的外部特征，进程的运动变化过程。同时它还是调度器的调度数据单元。

### 内核线程创建
1，定义中断栈
通过中断从用户态进入内核态（这期间也会有特权级的变化）用于中断发生时保护程序的上下文环境。
2，定义线程栈
线程自己的栈，保存待执行函数和线程切换时保存线程的环境。
3，定义PCB
4，定义函数
- thread_func
- thread_create
- thread_start
5，代码链路
- 首先申请一页内存(4k)，该页用于存放PCB信息
- 然后初始化PCB信息
- 在该页顶端预留出中断栈
- 在中断栈下预留出线程栈
- 然后将待执行函数和参数压入线程栈中
- ret发起调用：在create时，依次赋值kernel_thread，function，func_arg和4个ABI参数，赋值顺序也就是入栈顺序；调用时先弹出4个ABI参数，然后调用ret指令，这个时候栈中的参数和函数地址就会被弹出，并调用到。
{% asset_img thread_create.png thread create %}

### 线程调度
线程调度是由中断来驱动的。
1，注册中断处理函数
2，中断来了后，将当前线程的ticks减1，直到0；（中断来了还要保护当前线程的上下文）
3，变为0后，将当前线程ticks重新赋值，放到就绪队列队尾
4，然后去就绪队列对头取下一个要执行的线程

注意：中断发生后，CPU会自动将中断关闭，所以每次都要在软件中把中断打开。

### 调度保护
1，中断保护
进入中断前，要保护好当前CPU执行任务的上下文环境。
2，ABI主调函数环境保护
