---
title: OS Develop 7
date: 2022-07-18 15:34:13
tags:
   - IT-Basics
   - OS
---

### 简介
本章讨论中断。操作系统是中断来驱动的。


### IDT
用于存储中断处理程序入口的描述符表。
{% asset_img idt_format.png idt %}

中断门包含了中断处理程序所在段的段选择子和段内偏移地址。当通过此方式进入中断后，标志寄存器eflags 中的 IF 位自动置 0，也就是在进入中断后，自动把中断关闭，避免中断嵌套。Linux 就是利用中断门实现的系统调用，就是那个著名的 int 0x80。中断门只允许存在于IDT中。描述符中中断门的type值为二进制1110。


### 处理流程
1，外部设备的中断由中断代理芯片接收，处理后将该中断的中断向量号发送到CPU。
2，CPU执行该中断向量号对应的中断处理程序。


### 特权级检查
1，用户发起的软中断
对于软件发起的中断，当前特权级CPL必须在门描述符DPL和门中目标代码段DPL之间。

下限检查：处理器要检查当前特权级CPL和门描述符DPL，这是检查进门的特权下限，如果CPL权限大于等于DPL，即数值上CPL≤门描述符DPL，特权级“门槛”检查通过，进入下一步的“门框”检查。否则处理器抛出异常。

上限检查：处理器要检查当前特权级CPL和门描述符中所记录的选择子对应的目标代码段DPL，如果CPL权限小于目标代码段DPL，即数值上CPL>目标代码段DPL，检查通过。否则CPL若大于等于目标代码段DPL，处理器将引发异常，也就是说，除了用返回指令从高特权级 返回，特权转移只能发生在由低向高。

2，外部硬件引发的中断
处理器要检查当前特权级CPL和门描述符中所记录的选择子 对应的目标代码段DPL，如果CPL权限小于目标代码段DPL，即数值上CPL>目标代码段DPL，检查通过。否则CPL若大于等于目标代码段DPL，处理器将引发异常。
注意：中断时的CPL是不确定的，有可能是0，也有可能是3。

### 中断压栈
中断发生，从IDT中找到的目标代码段选择子将会刷新到CS，这个时候CPU就认为将要换了一个段，会把当前的CS，EIP，EFLAGS等寄存器的值压入栈中，这个栈是当前特权级的栈，以便中断处理程序执行完后，在恢复现场继续执行。

如果涉及到特权级的变化，还要将SS和ESP的值压入栈中，同时会将当前特权级栈中内容复制到目标特权级栈中。

如果有错误码，它会紧跟在EIP后入栈。错误码是描述符选择子。