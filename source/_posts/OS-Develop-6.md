---
title: OS Develop 6
date: 2022-06-7 18:13:02
tags:
   - IT-Basics
   - OS
---

### 简介
本章讨论特权级。
将操作系统看作服务器，用户进程看作客户端，两者是不同的特权级，客户端向服务端请求资源时，要做权限检查，这就是特权级检查。


### 特权级切换
有了操作系统后，程序分为用户程序和内核程序，前者是3特权级，后者是0特权级，两者加起来程序运行才完整，也就是说一个完整的程序运行要经历特权级的切换。
1，由低到高
由中断门、调用门等手段实现由低到高。
栈是记录特权切换时，保存切换前的特权级现场信息的，所以只有高特权级有栈，3特权级是最低的，所以不需要有栈。

2，由高到低
由调用返回指令从高到低。

由高到低，为啥3不需要栈？
当特权级切换时，CPU会自动把当前低特权级的栈地址(SS和ESP)压入转移后的高特权级的栈中。在用指令retf或iret从高到低返回时，处理器可以从当前高特权级的栈中拿到低特权级的栈地址(SS和ESP)，然后恢复切换后的低特权级的信息。

注意：
1，用目标特权级的栈，保存当前特权级的栈信息，这里别绕晕了。
2，特权级的切换，本质上就是切换CS和EIP的值，执行不同RPL的代码段。

### 特权级栈地址
1，程序员完成用户程序，操作系统完成内核态程序。特权级切换时，还要切换数据，为了防止引用混乱，每个CPU的不同特权级有自己的特权级栈，每个任务的每个特权级只有一个栈。当特权级切换时，也要将栈寄存器更新为对应特权级的栈。
2，任务在切换特权级时，去哪里找不同特权级下的栈呢？不同特权级下的栈地址(首地址)，是存放在TSS中的，在创建进程时，会初始化TSS，到后面TSS中的栈信息就不会变了。
3，TSS和GDT类似，都需要程序员来填写，然后添加到TR寄存器中。之后特权级切换时，CPU会根据程序员填写的TSS内容，自动刷新对应寄存器的内容。

### DPL，RPL和CPL
- CS中选择子的RPL代表指令的特权级(比如用户进程的指令特权级是3)，也是当前处理器所处的特权级，即CPL。

- DPL是段的特权级，如果段是代码段，那它的DPL就是未来Selector中RPL，就是未来CPU的特权级。

- 除了加载用户程序，其他时候都是目标段的DPL装载到选择子的RPL，然后变成了CPL。

### 特权级检查
操作系统中特权级的检查就是对DPL，CPL和RPL的大小关系检查。当访问者访问被防者的时候，就会做权限检查。
##### 1，对于数据段
只有“RPL值<=DPL值”(即高特权级的指令，访问比它特权级低的数据)时，才允许访问。
##### 2，对于代码段
情况1，“RPL值=DPL值”时，才允许访问。也就是只能平级访问。
情况2，在使用门结构(中断门，调用门)时，可以从低特权级到高特权级。
情况3，当从中断程序返回到用户态时，是从高特权级到低特权级。

中断发生后，CPU会暂停用户程序的执行，保存用户进程上下文，并跳转到0特权级，待中断处理程序执行完，就会回到用户进程继续执行。

##### 3，通过门结构访问
门选择子，门结构描述符，内核例程代码段，内核例程。

门结构是一段程序的内存段。任务门和调用门，在GDT中有门描述符来记录它的位置，因此可以用call和jmp指令直接调用。中断门和陷阱门仅存在IDT中，通过中断信号或int指令来触发。

门描述符的DPL值>=CPL的值，CPL的值<=门内核例程的DPL值。就是当前处理器的特权级，大于门描述符的特权级，小于门程序所在代码段的特权级。

通过门切换到高特权级：
1，首先调用门"call 门选择子"
2，通过门选择子在GDT中，找到门内核例程所在代码段的选择子和偏移量
3，最后通过内核例程代码段选择子和偏移量，找到例程在内存中的真实位置。

可见门调用会有两次特权检查，一个是从门选择子到门描述符，另一个是从门描述符到门内核例程代码段。门调用要求访问者的RPL，在门描述符DPL和内核例程代码段DPL之间。

通过retf切换到低特权级：
从低特权级切换到高特权级时，调用的call指令，因为是段间转移，CPU会将CS和EIP的值都备份到栈中。当执行retf指令时，CPU会将栈中的这两个值刷新回CS和EIP，这样就完成了由高到低的切换。

### OS防止用户篡改RPL
当用户程序请求时，OS会把用户提交选择子的RPL改为3。


### IO硬件访问控制
IO硬件的访问是由eflags中的IOPL位和TSS中IO位图来决定的，两者指定访问指定IO所需要的最小特权级。只有当特权级大于等于这个最小特权级时，才允许访问。


### 自动复制
为了方便软件开发人员，处理器在固件上实现参数的自动复制，即，将用户进程压在 3 特权级栈中的参数自动复制到 0 特权级栈中。




